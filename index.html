<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 2</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    var game = new Phaser.Game(config);
    var rock = [];
    var star = [];
    function preload ()
    {
        this.load.image('ship', 'assets/stark.png');
        this.load.image('rock', 'assets/bomb.png');
        this.load.image('star', 'assets/star.png');
    }

    function create ()
    {

      const pi = 3.141592653;

      keys = this.input.keyboard;
      keys.addKey("R");
      keys.addKey("UP");
      keys.addKey("LEFT");
      keys.addKey("DOWN");
      keys.addKey("RIGHT");
      keys.addKey("NUMPAD_NINE");
      keys.addKey("NUMPAD_THREE");
      console.log(keys);
      var ship = this.add.image(0,0, 'ship')
      ship.rv=0.0;
      ship.vx=0.0;
      ship.vy=0.0;

      var cam = this.cameras.main;
      const mapEdge = 2000; //max x and y and negative for mins
      cam.setBounds(-mapEdge, -mapEdge, mapEdge, mapEdge);
      cam.startFollow(ship);



      for (i=0; i<40; i++){
        rock[i] = this.add.image(0,0, 'rock')
        rock[i].rotation=Math.random()*2*pi;
        rock[i].rv=(Math.random()-0.5)*0.02;
        rock[i].x=Math.random()*800-400;
        rock[i].y=Math.random()*600-300;
        rock[i].vx=rock[i].y / 300 + (Math.random()-0.5)*0.02 ;
        rock[i].vy= (Math.random()-0.5)*0.02 ;
      }
      graphics = this.add.graphics({ lineStyle: { width: 2, color: 0x4444ff, alpha: 1 } });

      for (i=0; i<20; i++) {
        star[i] = this.add.image(Math.random()*800-400, Math.random()*600-300,'star');
        star[i].setScale((Math.random()*5+1)/20);
      }
    }

    function update ()
    {

      for (i=0; i<40; i++){
        rock[i].rotation+=rock[i].rv;
        rock[i].x+=rock[i].vx;
        rock[i].y+=rock[i].vy;
        if (rock[i].x<-5) rock[i].x+=810;
        if (rock[i].x>805) rock[i].x-=810;
        if (rock[i].y<-5) {
          rock[i].y+=610;
          rock[i].vx*=-1;
        }
        if (rock[i].y>605) {
          rock[i].y-=610;
          rock[i].vx*=-1;
        }
      }

      if (keys.UP.isDown()) //up arrow
      {
        ship.vx+=0.01*Math.sin(ship.rotation);
        ship.vy-=0.01*Math.cos(ship.rotation);
      }
      if (keys.LEFT.isDown()) //left arrow
      {
        if (ship.rv > -0.05)
          ship.rv-=0.002;
      }
      else if (keys.RIGHT.isDown()) //right arrow
      {
        if (ship.rv<0.05)
          ship.rv+=0.002;
      }
      else if (keys.DOWN.isDown()) //down arrow
      {
        if (ship.rv<0)
          ship.rv+=0.004;
        else ship.rv-=0.004;
        if (Math.abs(ship.rv)<0.004)
          ship.rv=0;
      }

      ship.rotation+=ship.rv;
      ship.x+=ship.vx;
      ship.y+=ship.vy;

      lines = [];
      lines.push([ship.x,ship.y])
      graphics.clear();
      for (i=-1; i<(mapEdge/200); i++) {
        l = new Phaser.Geom.Line﻿(i*200+100,-mapEdge+100,i*200+100,mapEdge-100);
        graphics.lineStyle(1, 0x004000);
        graphics.strokeLineShape(l);
      }
      for (i=-1; i<(mapEdge/200); i++) {
        l = new Phaser.Geom.Line﻿(-mapEdge+100,i*200+100,mapEdge-100,i*200+100);
        graphics.lineStyle(1, 0x004000);
        graphics.strokeLineShape(l);
      }
      /*
      for (i=1;i<9;i++){
        lines.push([lines[i-1][0]+20*ship.vx,lines[i-1][1]+20*ship.vy]);
        l = new Phaser.Geom.Line﻿(lines[i-1][0],lines[i-1][1],lines[i][0],lines[i][1]);
        graphics.lineStyle(10-i, Phaser.Display.Color.GetColor(72-7*i, 72-7*i, 280-30*i));
        graphics.strokeLineShape(l);
      }
*/

      //console.log("X:" + ship.x + " Y:" + ship.y);
      if (keys.R.isDown())
      {
        ship.x=0;
        ship.y=0;
        ship.vx=0;
        ship.vy=0;
        ship.vr=0;
        ship.rotation=0;
      }

    }

</script>

</body>
</html>
